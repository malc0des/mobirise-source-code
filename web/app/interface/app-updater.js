defineM("app-updater",function(a,l,c){function v(b,d,a){w().then(function(f){var g=b.ver||Bridge.version,h="";Bridge.getSettings("lastMessageDate",function(b){var k=(new Date).toISOString().split("T")[0];b?b!=k&&Bridge.getSettings("skippingAnnounce",function(b){Bridge.getSettings("skippingUpdateVer",function(e){Bridge.getSettings("lastMessageId",function(c){h=c||"";var r=parseInt(h.replace("#",""))||0;0<Bridge.versionCmp(e,g)&&(g=e);c=Bridge.substUrl(a)||document.location.href.replace(/[^/]+$/,"")+
"news.json?hash="+Math.random();x(c,function(a){if(a){var c=b||"",e=0;p.test(c)&&(e=parseInt(p.exec(c)[2]));var h,n,t;for(c=0;c<a.length&&a[c];c++){var m=a[c];if(p.test(m.id)){var q=p.exec(m.id)[1],u=parseInt(/\d+/.exec(m.id))||0;(f===q||"a"===q)&&u>e&&(!h||p.test(h.id)&&u<parseInt(p.exec(h.id)[2]))&&(h=m)}else/^#/.test(m.id)?(q=parseInt(m.id.replace("#",""))||0,q>r&&(!t||q<parseInt(t.id.replace("#","")))&&(t=m)):0<Bridge.versionCmp(m.id,g)&&(!n||0<Bridge.versionCmp(m.id,n.id))&&(n=m)}if(n=h||n||
t){n.message&&(n.message=n.message.join("\n"));if(d)try{d(n)}catch(z){}Bridge.setSettings("lastMessageDate",k)}}else l.rmExtension("app-updater")})})})}):Bridge.setSettings("lastMessageDate",k)})})}function x(a,d){function b(a){a&&Bridge.loadLocalFile(a,function(b){if(d){var c={};try{c=JSON.parse(b)}catch(e){console.log("Error in news.json: "+e.message+" at line "+e.line+" in file "+a)}d(c)}})}/^file:/.test(a)?b(a):Bridge.download2(a,function(a){b(a)})}function y(b){var d='<div class="modal fade no-select" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h4 class="modal-title">@TITLE@</h4></div><div class="modal-body">@MESSAGE@</div><div class="modal-footer"></div></div></div></div>',
f=c("New version $version$ is available").replace("$version$",b.id),g=f,k=c("Download now!"),h=c("Remind later");/^#/.test(b.id)&&(f=c("News"),g=c("Mobirise news is available, please visit $site url$ website for details.").replace("$site url$",'<a href="https://mobirise.com">Mobirise.com</a>'),k=c("Read more..."),h=c("Ok"));d=a(d.replace("@TITLE@",b.title||f).replace("@MESSAGE@",b.message||b.title||g));b.url&&a(".modal-footer",d).prepend(a('<button type="button" class="btn" data-dismiss="modal">@TEXT@</button>'.replace("@TEXT@",
k)).addClass("btn-success").click(function(){l.openUrl(b.url);d.modal("hide")}));f=a('[href*="app://stop"]',d);g=a('[href*="app://close"]',d);k=a('[href*="app://accept"]',d);var e=a('[href^="http"]',d),r=a("button",d);a().add(f).add(g).add(k).add(e).length||(g=a('<button type="button" class="btn" data-dismiss="modal">@TEXT@</button>'.replace("@TEXT@",h)),a(".modal-footer",d).prepend(g));if(p.test(b.id))a().add(f).add(g).add(k).add(e).add(r).on("click",function(){Bridge.setSettings("skippingAnnounce",
b.id)});else/^#/.test(b.id)?a().add(f).add(g).add(k).add(e).add(r).click(function(){Bridge.setSettings("lastMessageId",b.id)}):(f.length||(f=a('<button type="button" class="btn" data-dismiss="modal">@TEXT@</button>'.replace("@TEXT@",c("Skip this version"))),a(".modal-footer",d).prepend(f)),a().add(f).click(function(){Bridge.setSettings("skippingUpdateVer",b.id)}));e.each(function(){a(this).attr("_href",a(this).attr("href"))});e.click(function(b){b.preventDefault();l.openUrl(a(this).attr("_href"))});
a().add(f).add(g).add(k).add(e).attr("href","javascript:void(0)").click(function(){d.modal("hide")});d.on("hidden",function(){d.remove();l.rmExtension("app-updater")});h=d.modal({show:!0,keyboard:!1,backdrop:"static"});l.fire("showUpdaterWindow",h)}if("android"!=Bridge.getPlatform()){var p=/^\$(.)(\d+)/,w=function(){var b=a.Deferred();l.getAddons(function(a){"code-editor"in a?l.getAddonsEx(function(a,c,d){d&&a.length&&a[0].premium&&a[0].paid?b.resolve("p"):b.resolve("f")},{name:"code-editor"},{server:!0}):
b.resolve("f")});return b};l.regExtension({name:"app-updater",events:{bridgeInit:function(){l.on(["accountInited","signedin"],function(){!1!==l.getUserInfo()&&setTimeout(function(){v({},y,Bridge.sys2url(Bridge.args.updater)||"https://mobirise.com/news.json")},1E4)})}}})}},["jQuery","mbrApp","TR()"]);
